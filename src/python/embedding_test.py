image_file_name = "997722733_0cb5439472.jpg"
image_embedding = [
    0.012609683908522129,
    0.04037090763449669,
    -0.029071880504488945,
    0.017522431910037994,
    -0.015078968368470669,
    0.0072654010728001595,
    0.01988363452255726,
    -0.023690100759267807,
    -0.021254846826195717,
    0.028415773063898087,
    0.00504448264837265,
    -0.017513062804937363,
    0.05521296337246895,
    -0.03217529132962227,
    -0.035756126046180725,
    0.016964467242360115,
    -0.01637238822877407,
    -0.007288819178938866,
    -0.025646232068538666,
    -0.010919332504272461,
    -0.029221583157777786,
    -0.0011313153663650155,
    -0.005398200359195471,
    -0.09186167269945145,
    0.020837681367993355,
    0.05834074690937996,
    -0.004776427987962961,
    -0.011011182330548763,
    0.04102398082613945,
    0.015599673613905907,
    -0.02115168608725071,
    0.021732166409492493,
    -0.011582600884139538,
    0.00849086418747902,
    0.04897952079772949,
    -0.01608988083899021,
    0.02499794401228428,
    -0.011805381625890732,
    0.01863729953765869,
    -0.020716402679681778,
    -0.050996504724025726,
    -0.012215280905365944,
    -0.060781992971897125,
    -0.053688596934080124,
    -1.1503548194014002E-5,
    -0.13117250800132751,
    0.04128149896860123,
    0.0035481189843267202,
    -0.05959957093000412,
    0.024972233921289444,
    0.0185314379632473,
    -0.004309761803597212,
    0.06220861151814461,
    0.010823899880051613,
    -0.0028155690524727106,
    0.013804705813527107,
    0.015621277503669262,
    -0.0018775127828121185,
    -0.04396570473909378,
    0.009926890954375267,
    0.013631647452712059,
    -0.020808523520827293,
    0.02736823633313179,
    -0.01513130497187376,
    0.05195164680480957,
    -0.04155697673559189,
    0.02913624420762062,
    0.1276584416627884,
    0.022585321217775345,
    6.857372500235215E-5,
    0.0057141282595694065,
    -0.02690538391470909,
    -0.0015947693027555943,
    -0.017834141850471497,
    0.02527567185461521,
    -0.002879828680306673,
    0.01181699801236391,
    -0.0027546430937945843,
    0.0014622944872826338,
    0.03782442957162857,
    0.03748267516493797,
    0.06009204313158989,
    0.0790686085820198,
    0.03970237076282501,
    0.10518652200698853,
    0.030208487063646317,
    0.05990540608763695,
    -0.00343905296176672,
    0.016946934163570404,
    -0.029416896402835846,
    0.030197206884622574,
    0.030296705663204193,
    -0.6349184513092041,
    0.01939282938838005,
    0.0054831476882100105,
    -0.02461131475865841,
    0.003877940122038126,
    0.018235929310321808,
    -0.04378772899508476,
    -0.1213286891579628,
    0.02229495905339718,
    0.008026490919291973,
    -0.022479290142655373,
    0.005563321989029646,
    -0.0016172132454812527,
    0.03634084761142731,
    -0.13209916651248932,
    -0.032626256346702576,
    -0.011472686193883419,
    -0.016137581318616867,
    0.021649351343512535,
    -0.039015788584947586,
    0.002336671110242605,
    0.010400420054793358,
    -0.030830813571810722,
    -0.01826336607336998,
    0.02945719100534916,
    0.004196921829134226,
    0.023985613137483597,
    0.024490244686603546,
    0.001674931263551116,
    0.05065372958779335,
    -0.017751039937138557,
    0.00302735879085958,
    0.020949024707078934,
    0.007716786116361618,
    0.02674282342195511,
    -0.005065819714218378,
    0.00864326674491167,
    0.002081021899357438,
    0.03312651067972183,
    0.007453718688338995,
    0.012008978053927422,
    0.08411063253879547,
    0.028136862441897392,
    -9.145517251454294E-4,
    -0.010853270068764687,
    0.030863596126437187,
    -0.022108033299446106,
    -0.02168663777410984,
    -0.005941479932516813,
    -0.03715981915593147,
    -0.017999734729528427,
    0.036156848073005676,
    0.009796719998121262,
    2.1713250316679478E-4,
    -0.01317448541522026,
    0.06397297233343124,
    -0.03497566282749176,
    0.01158794667571783,
    -0.0206748079508543,
    0.03324656933546066,
    0.06673645228147507,
    -0.03260068595409393,
    -0.03919536992907524,
    -0.03496469557285309,
    0.005160210654139519,
    -0.03321368619799614,
    0.003987311385571957,
    0.007298856507986784,
    -0.015454732812941074,
    0.003388300072401762,
    -0.008905164897441864,
    0.049818046391010284,
    -0.004845325369387865,
    0.026886168867349625,
    0.021965699270367622,
    -0.017461378127336502,
    -7.976776105351746E-4,
    -0.03432823345065117,
    0.030940771102905273,
    0.04725794494152069,
    -0.012488480657339096,
    -0.05957619845867157,
    9.614746668376029E-4,
    -0.08520890027284622,
    -0.01868765614926815,
    -0.014636711217463017,
    0.024911997839808464,
    0.022696183994412422,
    0.009133468382060528,
    0.0021875558886677027,
    0.00836903601884842,
    0.023508606478571892,
    -0.02922731637954712,
    0.01646820828318596,
    0.011648380197584629,
    -0.025692328810691833,
    -0.020719014108181,
    0.0234379805624485,
    -0.017986055463552475,
    0.01836635172367096,
    0.014615663327276707,
    -0.047310471534729004,
    -0.03605664521455765,
    0.006501795724034309,
    0.01898088864982128,
    -0.01869768090546131,
    0.08523299545049667,
    0.0012481132289394736,
    -0.005576750263571739,
    -0.0246118251234293,
    -0.023549022153019905,
    0.05321038141846657,
    0.036027729511260986,
    -0.016289256513118744,
    -0.004112796857953072,
    -0.0014921831898391247,
    0.0013712651561945677,
    0.04403571039438248,
    -0.03753438964486122,
    -0.05410389602184296,
    0.024408463388681412,
    -0.002344702370464802,
    0.02998167648911476,
    -0.02379523776471615,
    0.014146777801215649,
    -0.013537018559873104,
    -0.04935719072818756,
    -0.011200668290257454,
    0.05125124752521515,
    0.03752606362104416,
    0.001181759755127132,
    -0.0017909235320985317,
    -0.052823398262262344,
    -0.026803908869624138,
    0.013339359313249588,
    0.00508938729763031,
    0.003742275992408395,
    0.040152277797460556,
    -0.0205997247248888,
    -0.013252456672489643,
    -0.03014172799885273,
    3.4864310873672366E-4,
    0.03172154724597931,
    -0.0796339213848114,
    0.014259994961321354,
    -0.0018742316169664264,
    0.035085566341876984,
    -0.013713874854147434,
    -0.0019581427332013845,
    -0.008664182387292385,
    -0.016612300649285316,
    -0.033080704510211945,
    -0.015692375600337982,
    -0.017970550805330276,
    -0.02482426166534424,
    0.007748624309897423,
    -0.017017900943756104,
    -0.007622431498020887,
    0.00791094172745943,
    0.009262828156352043,
    -0.009719643741846085,
    -0.019089672714471817,
    -0.020532630383968353,
    0.004504493437707424,
    -0.009623984806239605,
    0.008512620814144611,
    0.021224455907940865,
    0.034655213356018066,
    -0.02686273865401745,
    0.022102443501353264,
    0.045114804059267044,
    -0.030984319746494293,
    0.02199530228972435,
    -0.05906850844621658,
    -0.034115374088287354,
    0.02199975959956646,
    -0.006113880313932896,
    -0.01876796968281269,
    0.020100004971027374,
    -0.008985807187855244,
    0.028240514919161797,
    -0.04459529370069504,
    0.001544842729344964,
    0.02224629931151867,
    -0.05410536751151085,
    -0.05979827418923378,
    -0.017681783065199852,
    -0.014520949684083462,
    0.014139681123197079,
    0.003043563337996602,
    -0.030485503375530243,
    -0.003573585767298937,
    -0.020570460706949234,
    0.03258954733610153,
    0.05088607221841812,
    0.03559613227844238,
    0.0024265681859105825,
    -0.014969432726502419,
    -0.023735875263810158,
    -0.008249211125075817,
    -0.01125062070786953,
    -0.026573421433568,
    0.0029343541245907545,
    -0.009116724133491516,
    -0.039658695459365845,
    -0.02757205255329609,
    -0.00982959195971489,
    -0.0016505111707374454,
    0.028599515557289124,
    0.025146281346678734,
    -0.002304799621924758,
    0.016664788126945496,
    0.019418912008404732,
    -0.04331614822149277,
    0.013601081445813179,
    0.049559175968170166,
    0.019474197179079056,
    0.0013700479175895452,
    -0.01699191890656948,
    0.015064135193824768,
    0.08402355015277863,
    -0.005361194256693125,
    0.07149943709373474,
    -0.006985263433307409,
    -0.030340317636728287,
    0.04351482912898064,
    0.018944179639220238,
    -0.10723772644996643,
    0.05606784671545029,
    -0.03119608946144581,
    -0.05806700885295868,
    -0.011761784553527832,
    0.031732846051454544,
    0.010397638194262981,
    -0.020249003544449806,
    -0.04595149680972099,
    0.006492127664387226,
    -0.016498437151312828,
    -0.0011364297242835164,
    -0.011064678430557251,
    -0.013861843384802341,
    -0.03414464369416237,
    -0.03867693617939949,
    0.0022099658381193876,
    -0.04073017090559006,
    -0.013509813696146011,
    0.032771721482276917,
    -0.033707719296216965,
    0.0012731882743537426,
    -0.05739755928516388,
    0.0156569667160511,
    0.012940014712512493,
    -0.0020393093582242727,
    0.016886543482542038,
    -0.032524824142456055,
    -0.03493810445070267,
    0.01991170085966587,
    0.02791650779545307,
    -0.004490448161959648,
    0.0051065292209386826,
    0.06290192157030106,
    -0.03758298233151436,
    0.035137102007865906,
    -0.002095001982524991,
    -0.011588886380195618,
    -0.0827765092253685,
    0.03106248751282692,
    -0.032250627875328064,
    0.030472585931420326,
    -0.05543404072523117,
    -0.022270090878009796,
    0.02421555481851101,
    0.055674415081739426,
    -0.0320918895304203,
    0.005433218088001013,
    -0.09336592257022858,
    -0.04810022935271263,
    0.029811488464474678,
    0.029217427596449852,
    0.010262561962008476,
    -0.0011122123105451465,
    0.01758795604109764,
    0.005744945723563433,
    -0.0023990750778466463,
    0.1003534272313118,
    0.04389096051454544,
    0.049513962119817734,
    0.032403480261564255,
    0.00754708144813776,
    0.02745772711932659,
    -0.015806294977664948,
    -0.052774153649806976,
    0.015506165102124214,
    0.08551984280347824,
    0.04162706062197685,
    0.06071135029196739,
    -0.030616313219070435,
    0.05185095593333244,
    -0.027357906103134155,
    -0.04261166602373123,
    -0.004398574121296406,
    0.016482731327414513,
    0.0062676649540662766,
    -0.0059561035595834255,
    0.09474789351224899,
    0.013006933964788914,
    0.014370465651154518,
    -0.06518179923295975,
    0.03372165560722351,
    -0.017432894557714462,
    0.11791831254959106,
    -0.04076403006911278,
    0.035096053034067154,
    -0.03864195570349693,
    0.011893145740032196,
    -0.050851769745349884,
    0.01148365717381239,
    -0.030997326597571373,
    -0.0036126275081187487,
    0.030553288757801056,
    -0.04682566598057747,
    0.009913453832268715,
    -0.028969833627343178,
    0.047078415751457214,
    -0.04076748341321945,
    -0.017377659678459167,
    0.008299142122268677,
    -0.029276002198457718,
    0.020415283739566803,
    -0.024545958265662193,
    0.038290753960609436,
    -0.019620969891548157,
    0.029665634036064148,
    -0.014637450687587261,
    -0.04598597437143326,
    0.01689186878502369,
    0.003715751925483346,
    -0.0048346444964408875,
    0.0312460046261549,
    0.060345690697431564,
    -0.08205679059028625,
    0.03157968819141388,
    -0.02713436633348465,
    0.007285283412784338,
    0.015881486237049103,
    6.387720350176096E-4,
    -0.0014105587033554912,
    0.05733536183834076,
    0.03312413766980171,
    0.05037365108728409,
    0.03859313949942589,
    0.03153124451637268,
    0.03352908790111542,
    -0.04750379920005798,
    0.02445240318775177,
    -0.017576701939105988,
    -0.0086430124938488,
    0.024559756740927696,
    -0.026202498003840446,
    0.033178895711898804,
    -0.07604096084833145,
    0.00947683397680521,
    0.010165052488446236,
    -0.014736919663846493,
    0.040772438049316406,
    -0.06077061966061592,
    -0.0361982099711895,
    -0.012800074182450771,
    0.004737787414342165,
    0.004566562362015247,
    -0.044599197804927826,
    2.3776419402565807E-4,
    -0.005989018362015486,
    -0.026861311867833138,
    7.479377673007548E-4,
    -0.014558384194970131,
    0.007189463824033737,
    -0.006077917292714119,
    -0.04521125927567482,
    0.01637454889714718,
    0.02366946078836918,
    -0.02413024753332138,
    0.02795129455626011,
    0.027808092534542084,
    -0.012121506966650486,
    -0.018557507544755936,
    -0.03987700119614601,
    -0.032038476318120956,
    -0.033674456179142,
    -0.013554095290601254,
    0.0012749660527333617,
    -0.002656379947438836,
    -0.018499188125133514,
    0.014994279481470585,
    -0.042411405593156815,
    0.04853517562150955,
    -0.01659734547138214,
    0.025517385452985764,
    0.017421981319785118,
    -0.013873480260372162,
    0.014859170652925968,
    -0.06530977785587311,
    -0.010104654356837273,
    -0.008260438218712807,
    0.009256861172616482,
    0.008348732255399227,
    0.014732712879776955,
    -0.002026549307629466,
    -0.003863876685500145,
    -0.01240532472729683,
    0.002393793547526002,
    0.05543350800871849,
    0.06816481053829193,
    -0.056873906403779984,
    -0.010837904177606106,
    -0.020363138988614082,
    -0.03832501918077469,
    0.06380010396242142,
    0.013662970624864101,
    0.022236768156290054
]

from PIL import Image
import torch
from torchvision.transforms.transforms import Resize, CenterCrop, ToTensor, Normalize
from torchvision.transforms import InterpolationMode
import onnxruntime as ort
import numpy as np

image = Image.open(f"../../data/Flicker8k_Dataset/{image_file_name}")

"""
Compose(
    Resize(size=224, interpolation=bicubic, max_size=None, antialias=True)
    CenterCrop(size=(224, 224))
    <function _convert_image_to_rgb at 0x1260d9550>
    ToTensor()
    Normalize(mean=(0.48145466, 0.4578275, 0.40821073), std=(0.26862954, 0.26130258, 0.27577711))
)
"""

# The following are all steps required to compute embedding of an arbitrary image using only the ONNX model

image = Resize(size=224, interpolation=InterpolationMode.BICUBIC, max_size=None, antialias=True)(image)
image = CenterCrop(size=(224,224))(image)
image = image.convert("RGB")
image = ToTensor()(image)
image = Normalize(mean=(0.48145466, 0.4578275, 0.40821073), std=(0.26862954, 0.26130258, 0.27577711))(image)

assert type(image) == torch.Tensor

ort_sess = ort.InferenceSession("./transformer_image.onnx")
output = ort_sess.run(None, {"input": image.unsqueeze(0).numpy()})[0]

embedding = output[0]

print(embedding.shape, embedding.dtype)

normalized = embedding / np.linalg.norm(embedding)
print(normalized)
